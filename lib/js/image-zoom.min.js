"use strict";var ImageZoom=angular.module("ImageZoom",[]);ImageZoom.directive("imageZoom",["$document",function($document){return{restrict:"EA",replace:!0,templateUrl:"image-zoom.html",scope:{imageSrc:"@"},link:function($scope,element){var el,nWidth,nHeight,lensCSS,lens=element.find("div"),image=element.find("img"),isLensHidden=!1,isImageLoading=!1,watchImageSrc=$scope.$parent.$watch("imageSrc",function(newVale){newVale&&($scope.imageSrc=newVale)});if(!("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)){var hideLens=function(){lens.css({opacity:0,filter:"alpha(opacity=0)",display:"none"}),isLensHidden=!0},showGlass=function(){lens.css({display:"block",opacity:1,filter:"alpha(opacity=100)"})},changeLensBgImg=function(img){lens.css({background:"url("+img+") no-repeat","background-size":nHeight+" "+nWidth})},mousemove=function(evt){lensCSS=$scope.magnify(evt),lensCSS&&lens.css(lensCSS)},mouseleave=function(){console.log("[mouseleave]"),hideLens(),$document.off("mousemove",mousemove),$document.off("mouseleave",mouseleave)};element.on("mouseenter",function(){isLensHidden&&showGlass();var extInfo={width:element[0].offsetWidth,height:element[0].offsetHeight,imageWidth:image[0].offsetWidth,imageHeight:image[0].offsetHeight,lensWidth:lens[0].offsetWidth,lensHeight:lens[0].offsetHeight};el=angular.extend($scope.getOffset(element[0]),extInfo),$document.on("mousemove",mousemove),$document.on("mouseleave",mouseleave)}),element.on("destroy",watchImageSrc),image.bind("load",function(){nWidth=image.naturalWidth,nHeight=image.naturalHeight,changeLensBgImg($scope.imageSrc)});var getLensBgStyle=function(evt){var mx,my,rx,ry,px,py,bgp,mx=evt.pageX?evt.pageX-el.left:evt.x;return my=evt.pageY?evt.pageY-el.top:evt.y,mx<el.width&&my<el.height&&mx>0&&my>0?(showGlass(),rx=-1*Math.round(mx/el.width*nWidth-el.lensWidth/2),ry=-1*Math.round(my/el.height*nHeight-el.lensHeight/2),bgp=rx+"px "+ry+"px",px=mx-el.lensWidth/2,py=my-el.lensHeight/2,{left:px+"px",top:py+"px",backgroundPosition:bgp}):void hideLens()};$scope.magnify=function(evt){var img;return nWidth||nHeight?getLensBgStyle(evt):void(isImageLoading||(img=new Image,img.onload=function(){nWidth=img.width,nHeight=img.height,isImageLoading=!1},img.src=$scope.imageSrc,isImageLoading=!0))},$scope.getOffset=function(el){var offsetLeft=0,offsetTop=0;return el&&(isNaN(el.offsetLeft)||(offsetLeft+=el.offsetLeft,offsetTop+=el.offsetTop),el=el.offsetParent),{left:offsetLeft,top:offsetTop}},$scope.getLensStyle=function(){return{background:"url("+$scope.imageSrc+") no-repeat",width:$scope.lensWidth?$scope.lensWidth+"px":"",height:$scope.lensHeight?$scope.lensHeight+"px":""}}}}}}]);